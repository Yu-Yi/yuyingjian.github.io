I"yÙ<ul id="markdown-toc">
  <li><a href="#ä¸€ä¸ªæ¦‚å¿µ" id="markdown-toc-ä¸€ä¸ªæ¦‚å¿µ">ä¸€ä¸ªæ¦‚å¿µ</a>    <ul>
      <li><a href="#event-loop" id="markdown-toc-event-loop">Event Loop</a></li>
      <li><a href="#å¹¶è¡Œ" id="markdown-toc-å¹¶è¡Œ">å¹¶è¡Œ</a></li>
      <li><a href="#è¿è¡Œè‡³å®Œæˆ" id="markdown-toc-è¿è¡Œè‡³å®Œæˆ">è¿è¡Œè‡³å®Œæˆ</a></li>
      <li><a href="#å¹¶å‘" id="markdown-toc-å¹¶å‘">å¹¶å‘</a></li>
      <li><a href="#job-queue" id="markdown-toc-job-queue">Job queue</a></li>
    </ul>
  </li>
  <li><a href="#å›è°ƒå‡½æ•°" id="markdown-toc-å›è°ƒå‡½æ•°">å›è°ƒå‡½æ•°</a>    <ul>
      <li><a href="#callback-hell" id="markdown-toc-callback-hell">callback hell</a></li>
      <li><a href="#ä¿¡ä»»é—®é¢˜" id="markdown-toc-ä¿¡ä»»é—®é¢˜">ä¿¡ä»»é—®é¢˜</a></li>
      <li><a href="#æ‹¯æ•‘å›è°ƒ" id="markdown-toc-æ‹¯æ•‘å›è°ƒ">æ‹¯æ•‘å›è°ƒ</a>        <ul>
          <li><a href="#åˆ†ç¦»å›è°ƒçš„è®¾è®¡" id="markdown-toc-åˆ†ç¦»å›è°ƒçš„è®¾è®¡">åˆ†ç¦»å›è°ƒçš„è®¾è®¡</a></li>
          <li><a href="#é”™è¯¯ä¼˜å…ˆé£æ ¼" id="markdown-toc-é”™è¯¯ä¼˜å…ˆé£æ ¼">é”™è¯¯ä¼˜å…ˆé£æ ¼</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#promise" id="markdown-toc-promise">Promise</a>    <ul>
      <li><a href="#åŸºæœ¬æ¦‚å¿µ" id="markdown-toc-åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</a></li>
      <li><a href="#catch" id="markdown-toc-catch">catch()</a></li>
      <li><a href="#promise-é“¾" id="markdown-toc-promise-é“¾">promise é“¾</a></li>
      <li><a href="#new-promise-æ„é€ å™¨" id="markdown-toc-new-promise-æ„é€ å™¨">new Promise() æ„é€ å™¨</a></li>
      <li><a href="#åˆ›å»º-settled-promise" id="markdown-toc-åˆ›å»º-settled-promise">åˆ›å»º settled promise</a></li>
      <li><a href="#promiseall-å’Œ-promiserace" id="markdown-toc-promiseall-å’Œ-promiserace">Promise.all([â€¦]) å’Œ Promise.race([â€¦])</a></li>
      <li><a href="#promise-ä¸å¯æ’¤é”€" id="markdown-toc-promise-ä¸å¯æ’¤é”€">Promise ä¸å¯æ’¤é”€</a></li>
    </ul>
  </li>
  <li><a href="#async-å’Œ-await" id="markdown-toc-async-å’Œ-await">async å’Œ await</a></li>
</ul>

<p>å¼‚æ­¥ç¼–ç¨‹æ˜¯ JavaScript ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µã€‚å¼‚æ­¥çš„æ ¸å¿ƒæ˜¯<strong>ç°åœ¨</strong>å’Œ<strong>ç¨å</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„ä¸€ä¸ª JavaScript ç¨‹åºï¼Œä»…æœ‰å…¶ä¸­çš„ä¸€ä¸ªä»£ç å—ä¼šåœ¨ <em>ç°åœ¨</em> æ‰§è¡Œï¼Œè€Œå…¶ä»–çš„ä¼š <em>ç¨å</em> æ‰§è¡Œã€‚</p>

<p>æœ€å¸¸è§çš„å¼‚æ­¥ç¼–ç¨‹å°±æ˜¯å›è°ƒå‡½æ•°äº†ã€‚</p>

<!-- more -->

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ajax() æ˜¯æŸä¸ªåŒ…ä¸­ä»»æ„çš„ Ajax å‡½æ•°</span>
<span class="nx">ajax</span> <span class="p">(</span><span class="dl">'</span><span class="s1">http://xiaokedada.com</span><span class="dl">'</span><span class="p">,</span><span class="kd">function</span> <span class="nx">callbackFunction</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="c1">//åº”ç­”ä»£ç </span>
<span class="p">});</span>
</code></pre></div></div>

<p>åœ¨å¼‚æ­¥è°ƒç”¨ ajax çš„è¿‡ç¨‹ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">callbackFunction()</code> ä¸ä¼šé©¬ä¸Šæ‰§è¡Œï¼Œè€Œæ˜¯ ç¨å æ‰§è¡Œã€‚</p>

<p>æœ€å¼€å§‹ï¼Œæˆ‘ä»¬è¦ç†è§£ä¸€äº›æ¦‚å¿µä¹‹ç±»çš„ä¸œè¥¿ã€‚</p>

<h2 id="ä¸€ä¸ªæ¦‚å¿µ">ä¸€ä¸ªæ¦‚å¿µ</h2>

<h3 id="event-loop">Event Loop</h3>

<p>å°±æ‹¿ä¸Šé¢è¿™ä¸ª ajax çš„å›è°ƒå‡½æ•°æ¥è®²ï¼Œå½“æœ‰æ•°æ®éœ€è¦è¿”å›æ—¶ï¼Œå°±ä¼šå°†è¿™ä¸ªå›è°ƒå‡½æ•°æ’å…¥ Event Loop æ¥å®‰æ’å®ƒçš„æ‰§è¡Œã€‚Event Loop ç±»ä¼¼äºä¸‹é¢çš„ä»£ç :</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Event Loop è¡¨ç°å¾—åƒä¸€ä¸ªé˜Ÿåˆ—</span>

<span class="kd">var</span> <span class="nx">eventLoop</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">event</span><span class="p">;</span>

<span class="c1">//ä¸æ–­è½®è¯¢</span>
<span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">){</span>
    <span class="c1">// æ‰§è¡Œä¸€ä¸ª tick</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">eventLoop</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="nx">event</span> <span class="o">=</span> <span class="nx">eventLoop</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="c1">//shift() æ¨¡æ‹Ÿé˜Ÿåˆ—ï¼Œå–å¾—ä¸‹ä¸€ä¸ªäº‹ä»¶</span>
    <span class="p">}</span>
    <span class="c1">// æ‰§è¡Œä¸‹ä¸€ä¸ªäº‹ä»¶</span>
    <span class="k">try</span> <span class="p">(){</span>
        <span class="nx">event</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">reportErr</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å¹¶è¡Œ">å¹¶è¡Œ</h3>

<p>å¼‚æ­¥å’Œå¹¶è¡Œæ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µã€‚å¹¶è¡Œè¡¨ç¤ºäº‹æƒ…å¯ä»¥åŒæ—¶å‘ç”Ÿï¼Œæœ€å¸¸è§çš„å°±æ˜¯ <em>çº¿ç¨‹</em> å’Œ <em>è¿›ç¨‹</em>ã€‚è¿›ç¨‹å’Œçº¿ç¨‹ç‹¬ç«‹åœ°ã€å¯èƒ½åŒæ—¶åœ°æ‰§è¡Œã€‚</p>

<h3 id="è¿è¡Œè‡³å®Œæˆ">è¿è¡Œè‡³å®Œæˆ</h3>

<p>å› ä¸º JavaScript æ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸€ä¸ªå‡½æ•°(æ¯”å¦‚: <code class="language-plaintext highlighter-rouge">foo(){...}</code>) å†…éƒ¨çš„ä»£ç æ˜¯ <strong>åŸå­æ€§</strong> çš„ï¼Œæ„å‘³ç€ <code class="language-plaintext highlighter-rouge">foo()</code> ä¸€æ—¦æ‰§è¡Œï¼Œå°±å¿…é¡»å…¨éƒ¨æ‰§è¡Œï¼Œè€Œä¸ä¼šè¢«å…¶ä»– <em>å‡½æ•°</em> æ‰“æ–­ã€‚</p>

<h3 id="å¹¶å‘">å¹¶å‘</h3>

<p>å¹¶å‘æ˜¯å½“ä¸¤ä¸ªæˆ–å¤šä¸ª <em>è¿›ç¨‹</em> åœ¨åŒä¸€æ—¶é—´æ®µå†…åŒæ—¶æ‰§è¡Œã€‚å¯ä»¥è®¤ä¸ºå¹¶å‘æ˜¯ <em>è¿›ç¨‹</em> çº§åˆ«çš„å¹¶è¡Œæœºåˆ¶ï¼Œè€Œä¸æ˜¯ <em>çº¿ç¨‹</em> çº§åˆ«çš„å¹¶è¡Œæœºåˆ¶ã€‚</p>

<h3 id="job-queue">Job queue</h3>

<p>Job queue æ˜¯ Event Loop ä¹‹ä¸Šçš„ä¸€å±‚æ–°æ¦‚å¿µï¼Œå¯ä»¥è®¤ä¸º:</p>

<blockquote>
  <p>Job queue æ˜¯æŒ‚é åœ¨äº‹ä»¶è½®è¯¢é˜Ÿåˆ—çš„æ¯ä¸ª tick æœ«å°¾çš„é˜Ÿåˆ—ã€‚</p>
</blockquote>

<p>æœ‰ç‚¹åƒ <code class="language-plaintext highlighter-rouge">setTimeout(...,0)</code> çš„é»‘ç§‘æŠ€ï¼Œä»¥ä¸€ç§æ›´æ˜ç¡®çš„æ–¹å¼å‘Šè¯‰ä½ : <strong>ç¨åï¼Œä½†å°½å¿«</strong>ã€‚</p>

<hr />

<h2 id="å›è°ƒå‡½æ•°">å›è°ƒå‡½æ•°</h2>

<p>å¼‚æ­¥ç¼–ç¨‹å°±åŸºæœ¬çš„å½¢å¼ï¼Œå°±æ˜¯ äº‹ä»¶æ¨¡å‹ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">my-btn</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">button</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//do something</span>
<span class="p">};</span>
</code></pre></div></div>

<p>æŒ‰é’®åœ¨è¢«ç‚¹å‡»ä¹‹åï¼Œ<code class="language-plaintext highlighter-rouge">onclick</code> å†…éƒ¨çš„ä»£ç æ‰ä¼šåŠ å…¥ EventLoop è¿›è¡Œæ‰§è¡Œã€‚</p>

<p>åœ¨æ¯”å¦‚:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){...},</span> <span class="mi">100</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">i love yuer</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">setTimeout()</code> ä¸­çš„å›è°ƒå‡½æ•°å¹¶ä¸ä¼šé©¬ä¸Šæ‰§è¡Œï¼Œè€Œæ˜¯ä¼šåœ¨ 100ms ä¹‹åè¢«åŠ å…¥åˆ° Event Loopã€‚</p>

<p>Node.js è¯ç”Ÿä¹‹åï¼Œå›è°ƒæ¨¡å¼å°±æ›´å¹¿æ³›äº†ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">readFile</span> <span class="p">(</span><span class="dl">"</span><span class="s2">my.txt</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">contents</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span>
<span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">i love yuer</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div>

<p>å›è°ƒå‡½æ•°æ˜¯ä¸‡èƒ½çš„å—ï¼Ÿå¹¶ä¸æ˜¯ã€‚</p>

<h3 id="callback-hell">callback hell</h3>

<p><strong>å›è°ƒåœ°ç‹±</strong> æ˜¯å›è°ƒå‡½æ•°é¢ä¸´çš„ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">listen</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span><span class="kd">function</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">evt</span><span class="p">){</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="nx">request</span><span class="p">(){</span>
        <span class="nx">ajax</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://xiaodedada.com</span><span class="dl">'</span><span class="p">,</span><span class="kd">function</span> <span class="nx">response</span><span class="p">(</span><span class="nx">text</span><span class="p">){</span>
            <span class="p">...</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h3 id="ä¿¡ä»»é—®é¢˜">ä¿¡ä»»é—®é¢˜</h3>

<p>è¿˜æ˜¯æˆ‘ä»¬é‚£ä¸ªå¼€å¤´çš„ <code class="language-plaintext highlighter-rouge">ajax()</code> å‡½æ•°ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//A</span>
<span class="nx">ajax</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://xiaodedada.com</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="c1">//B</span>
<span class="p">});</span>
<span class="c1">//C</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">A</code> å’Œ <code class="language-plaintext highlighter-rouge">C</code> æ˜¯ ç°åœ¨ å‘ç”Ÿçš„ï¼Œè€Œä¸”åœ¨æˆ‘ä»¬çš„æ§åˆ¶ä¹‹ä¸‹ï¼Œä½†æ˜¯ <code class="language-plaintext highlighter-rouge">B</code> æ¨è¿Ÿåˆ° ç¨å å‘ç”Ÿï¼Œè€Œä¸”æ˜¯åœ¨ <code class="language-plaintext highlighter-rouge">ajax()</code> çš„æ§åˆ¶ä¹‹ä¸‹ã€‚å¦‚æœè¿™ä¸ª <code class="language-plaintext highlighter-rouge">ajax()</code> ä¸æ˜¯ä½ å†™çš„ï¼Œæ›´ä¸€èˆ¬çš„æƒ…å†µæ˜¯ï¼Œå®ƒæ˜¯ç”±ç¬¬ä¸‰æ–¹æä¾›ï¼Œè¿™æ„å‘³ç€ <strong>æ§åˆ¶æƒè¢«è½¬äº¤ç»™ç¬¬ä¸‰æ–¹</strong>(æ§åˆ¶åè½¬)ã€‚ä½ å½“ç„¶å¸Œæœ›ç¬¬ä¸‰æ–¹æ˜¯å¯é çš„ï¼Œä½†æ˜¯ä½ åªæ˜¯å¯„å¸Œæœ›äºè‡ªå·±æ‰€æ— æ³•æ§åˆ¶çš„äº‹ç‰©èº«ä¸Šè€Œå·²ã€‚</p>

<h3 id="æ‹¯æ•‘å›è°ƒ">æ‹¯æ•‘å›è°ƒ</h3>

<h4 id="åˆ†ç¦»å›è°ƒçš„è®¾è®¡">åˆ†ç¦»å›è°ƒçš„è®¾è®¡</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">success</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//do something</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">failure</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//handler error</span>
<span class="p">}</span>
<span class="nx">ajax</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://xiaokedada.com</span><span class="dl">'</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">);</span>
</code></pre></div></div>

<p>API è®¾è®¡çš„æ—¶å€™é€šè¿‡åˆ†ç¦»å›è°ƒï¼Œä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œä¸€ä¸ªç”¨äºæˆåŠŸçš„é€šçŸ¥ï¼Œä¸€ä¸ªç”¨äºé”™è¯¯çš„é€šçŸ¥ã€‚</p>

<blockquote>
  <p>Promise å°±æ˜¯é‡‡ç”¨è¿™ç§ åˆ†ç¦»å›è°ƒ çš„è®¾è®¡ã€‚</p>
</blockquote>

<h4 id="é”™è¯¯ä¼˜å…ˆé£æ ¼">é”™è¯¯ä¼˜å…ˆé£æ ¼</h4>

<p>è¿™ä¸ª Node.js æƒ¯å¸¸ä½¿ç”¨çš„ä¸€ä¸ªå›è°ƒé£æ ¼ã€‚ä¸Šé¢çš„è¿™ä¸ªä¾‹å­å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªé£æ ¼ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">readFile</span> <span class="p">(</span><span class="dl">"</span><span class="s2">my.txt</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">contents</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span>
<span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">i love yuer</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div>

<p>ä½†æ˜¯ï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½ä¸èƒ½çœŸæ­£åœ°æ‹¯æ•‘å›è°ƒï¼Œå¹¶ä¸èƒ½çœŸæ­£åœ°è§£å†³ä¿¡ä»»å±æœºã€‚</p>

<hr />

<h2 id="promise">Promise</h2>

<h3 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3>

<p>Promises æ˜¯é’ˆå¯¹å›è°ƒçš„ <em>æ§åˆ¶åè½¬</em> æä¾›è§£å†³æ–¹æ¡ˆã€‚è¿™æ„å‘³ç€ <em>ä¸æ˜¯å°†ç¨‹åºäº¤ç»™ç¬¬ä¸‰æ–¹ï¼Œè€Œæ˜¯å¸Œæœ›å®ƒè¿”å›ç»™æˆ‘ä»¬ä¸€ä¸ªå¯çŸ¥é“å®ƒä½•æ—¶å®Œæˆçš„ä¸œè¥¿ï¼Œè®©æˆ‘ä»¬è‡ªå·±å†³å®šä¸‹ä¸€æ­¥åšä»€ä¹ˆ</em>ã€‚ä¹Ÿå°±æ˜¯ï¼Œå°† <em>æ§åˆ¶åè½¬</em> å†åè½¬è¿‡æ¥ã€‚</p>

<blockquote>
  <p>Promise æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥ä¼ é€’å¼‚æ­¥æ“ä½œçš„æ¶ˆæ¯ã€‚ä»£è¡¨äº†æŸä¸ªæœªæ¥æ‰ä¼šçŸ¥é“ç»“æœçš„äº‹ä»¶ã€‚ ã€ŠES6 æ ‡å‡†å…¥é—¨ã€‹</p>
</blockquote>

<p>Promise çš„å¯¹è±¡çš„çŠ¶æ€ä¸å—å¤–éƒ¨å½±å“ï¼Œä¹Ÿç§°ä¸º promise çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pending</code>: æŒ‚èµ·çŠ¶æ€ï¼Œä¸€å¼€å§‹éƒ½å¤„äºè¿™ä¸ªçŠ¶æ€ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">resolved</code>: å¼‚æ­¥æ“ä½œå·²å®Œæˆ</li>
  <li><code class="language-plaintext highlighter-rouge">rejected</code>: å¼‚æ­¥æ“ä½œå¤±è´¥</li>
</ul>

<blockquote>
  <p>pending çŠ¶æ€çš„ promise è¢«è®¤ä¸ºæ˜¯ <code class="language-plaintext highlighter-rouge">unsettled</code>ã€‚ä¸€æ—¦å¼‚æ­¥æ“ä½œå®Œæˆ(ä¸ç®¡æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥)ï¼Œå°±è¢«è®¤ä¸ºæ˜¯ <code class="language-plaintext highlighter-rouge">settled</code>ã€‚</p>
</blockquote>

<p>Promise çš„çŠ¶æ€ä¸€æ—¦æ”¹å˜å°±ä¸ä¼šå†å˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œpromise å¯¹è±¡çš„æ”¹å˜åªæœ‰ä¸¤ç§æ–¹å¼: ä» pending å˜æˆ resolved å’Œ ä» pending å˜æˆ rejectedã€‚åªè¦äºŒè€…ä¹‹ä¸€å‘ç”Ÿï¼ŒçŠ¶æ€å°±å‡å›ºäº†ï¼Œä¸ä¼šå†å˜ï¼Œä»»ä½•æ—¶å€™è®¿é—®éƒ½æ˜¯è¿™ä¸ªç»“æœã€‚</p>

<blockquote>
  <p>è¿™å’Œ äº‹ä»¶æœºåˆ¶ å®Œå…¨ä¸åŒï¼Œä¸€æ—¦é”™è¿‡ï¼Œå†å»ç›‘å¬å°±å¾—ä¸åˆ°ç»“æœã€‚</p>
</blockquote>

<p>æ‰€ä»¥çš„ promise éƒ½æœ‰ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">then()</code> æ–¹æ³•æ¥æŒ‡å®šå¼‚æ­¥æ“ä½œå®Œæˆåçš„ä¸€äº›æ“ä½œï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ promise ä¸º fulfilled çŠ¶æ€ä¸‹è°ƒç”¨çš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ promise ä¸º rejected çŠ¶æ€ä¸‹è°ƒç”¨çš„å‡½æ•°ã€‚å…¶ä¸­ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯é€‰çš„ã€‚</p>

<p>æˆ‘ä»¬ä¸¾ä¸ª promise æ“ä½œ AJAX çš„ä¾‹å­æ¥è®¤è¯†ä¸€ä¸‹:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">getJSON</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">json</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Accept</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>

    <span class="kd">function</span> <span class="nx">handler</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statusText</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">promise</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">getJSON</span><span class="p">(</span><span class="dl">"</span><span class="s2">/posts.json</span><span class="dl">"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Contents: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">json</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">å‡ºé”™äº†</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<blockquote>
  <p>ä¾‹å­æ¥æº ã€ŠES6 æ ‡å‡†å…¥é—¨ã€‹</p>
</blockquote>

<p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œpromise å¯¹è±¡é€šè¿‡ Promise æ„é€ å‡½æ•°æ„å»ºã€‚æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼Œè¯¥æ‰§è¡Œå‡½æ•°æ¥æ”¶ resolve() å’Œ reject() ä¸¤ä¸ªå‚æ•°ã€‚resolve() å‡½æ•°ä¼šåœ¨æ‰§è¡Œå‡½æ•°æˆåŠŸè¿è¡Œåè¡¨ç¤ºè¯¥ promise å¯ç”¨ï¼Œè€Œ reject() å‡½æ•°ä»£è¡¨è¯¥æ‰§è¡Œå‡½æ•°è¿è¡Œå¤±è´¥ã€‚ç„¶åè°ƒç”¨ <code class="language-plaintext highlighter-rouge">then()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨ promise çŠ¶æ€æ”¹å˜çš„æ—¶å€™è¿›è¡Œ <strong>å¼‚æ­¥è°ƒç”¨</strong>ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ã€‚</p>

<p>æ¯”å¦‚ä¸‹é¢æˆ‘å†™çš„è¿™ä¸ªä¾‹å­:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">foo</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">resolved</span><span class="dl">'</span><span class="p">);</span>
<span class="p">},</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">yuer</span><span class="dl">'</span><span class="p">);</span>
<span class="cm">/*
yuer
resolved
*/</span>
</code></pre></div></div>

<p>ç”±äº <code class="language-plaintext highlighter-rouge">then()</code> æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œæ‰€ä»¥ä¼šå…ˆè¾“å‡º <code class="language-plaintext highlighter-rouge">yuer</code>ï¼Œç„¶åæ˜¯æˆåŠŸçš„ç»“æœã€‚</p>

<blockquote>
  <p>ä»¥è¿™ç§æ–¹å¼å®ç° then() æ–¹æ³•çš„å¯¹è±¡ç§°ä¸º thenableã€‚æ‰€æœ‰çš„ promise éƒ½æ˜¯ thenableï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„ thenable éƒ½æ˜¯ promiseã€‚</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">thenable</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">then</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">){</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">yuer</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">thenable</span><span class="p">);</span>
<span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">I love </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">thenable</code> æ ¹æœ¬ä¸åƒ Promiseï¼Œä½†ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ª thenableã€‚é€šè¿‡è°ƒç”¨ Promise.resolve() å°†è¿™ä¸ªå¯¹è±¡è½¬åŒ–ä¸º å®Œæˆ çŠ¶æ€çš„ promiseã€‚</p>

<h3 id="catch">catch()</h3>

<p>åˆšæ‰æˆ‘ä»¬è®²è¿‡ <code class="language-plaintext highlighter-rouge">then()</code> å‡½æ•°ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">catch()</code> ä¸»è¦æ˜¯æ¥å—ä¸€ä¸ª rejected ä½œä¸ºå›è°ƒï¼Œç­‰åŒäº <code class="language-plaintext highlighter-rouge">then(null,rejected)</code>ã€‚è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå’Œ then() ä¸€æ ·ï¼Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">foo</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nx">promise</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">rejected</span><span class="dl">'</span><span class="p">);</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">yuer</span><span class="dl">'</span><span class="p">);</span>
<span class="cm">/*
yuer
*/</span>
</code></pre></div></div>

<h3 id="promise-é“¾">promise é“¾</h3>

<p>åˆšæ‰æœ‰è¯´åˆ°ï¼Œthen() å’Œ catch() éƒ½ä¼šè¿”å›ä¸€ä¸ª Promise å®ä¾‹ï¼Œå°±å¯ä»¥ä½¿ç”¨å®ƒä»¬æ„å»º promise é“¾ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">foo</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">resolved</span><span class="dl">'</span><span class="p">);</span>
<span class="p">},</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">another resolved</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">yuer</span><span class="dl">'</span><span class="p">);</span>
<span class="cm">/*
yuer
resolved
another resolved
*/</span>
</code></pre></div></div>

<h3 id="new-promise-æ„é€ å™¨">new Promise() æ„é€ å™¨</h3>

<p>ä¸Šé¢æˆ‘ä»¬å±•ç¤ºäº† new Promise() çš„ç”¨æ³•ï¼Œæ¥æ”¶ä¸€ä¸ªå¤„ç†å›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ <strong>åŒæ­¥æˆ–è€…ç«‹å³æ‰§è¡Œ</strong> çš„ã€‚åŒæ—¶ï¼Œè¿™ä¸ªå‡½æ•°è¿˜æ¥æ”¶ä¸¤ä¸ªå‡½æ•°å›è°ƒï¼Œ<code class="language-plaintext highlighter-rouge">resolve()</code> å’Œ <code class="language-plaintext highlighter-rouge">reject()</code>ã€‚reject() ç”¨äºæ‹’ç»è¿™ä¸ª promiseï¼Œä½† resolve() å¯èƒ½å®Œæˆ promiseï¼Œä¹Ÿå¯èƒ½éœ€è¦è¿›ä¸€æ­¥å†³è®®è¿™ä¸ª promiseã€‚</p>

<p>å¦‚æœä¼ ç»™ <code class="language-plaintext highlighter-rouge">resolved()</code> çš„æ˜¯ä¸€ä¸ªé Promiseã€é thenable çš„ç«‹å³å€¼ï¼Œè¿™ä¸ª promise å°±ä¼šè¿™ä¸ªå€¼ç«‹å³å®Œæˆã€‚å¦‚æœæ˜¯ä¸€ä¸ªçœŸæ­£çš„ Promise æˆ– thenable å€¼ï¼Œè¿™ä¸ªå€¼ä¼šè¢«é€’å½’å±•å¼€ï¼Œè€Œä¸”æ— è®ºå®ƒæœ€ç»ˆè§£æç»“æœ/çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Œéƒ½ä¼šè¢« promise é‡‡ç”¨ã€‚</p>

<h3 id="åˆ›å»º-settled-promise">åˆ›å»º settled promise</h3>

<p>é€šè¿‡ new Promise() æˆ‘ä»¬åˆ›å»ºçš„æ˜¯ unsettled çš„ promiseï¼Œä¹Ÿå°±æ˜¯è¯´åˆ›å»ºå®Œ promise ä¹‹åï¼Œå®ƒçš„çŠ¶æ€æ˜¯æœªå®šçš„ã€‚è€Œåˆ›å»º å·²å®š çš„promiseï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">Promise.resolve()</code> å’Œ <code class="language-plaintext highlighter-rouge">Promise.reject()</code> æ¥åˆ›å»ºã€‚</p>

<ul>
  <li>Promise.resolve() æ–¹æ³•æ¥æ”¶å•ä¸ªå‚æ•°å¹¶è¿”å›ä¸€ä¸ª å®ŒæˆçŠ¶æ€ çš„ promiseã€‚</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">yuer</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">I love </span><span class="dl">'</span><span class="o">+</span> <span class="nx">str</span><span class="p">);</span>
<span class="p">});</span>
<span class="cm">/*
I love yuer
*/</span>
</code></pre></div></div>

<p>å¦‚æœä¼ é€’çš„æ˜¯ catch() å¤„ç†ï¼Œåˆ™æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸º promise ä¸å­˜åœ¨ rejected çŠ¶æ€ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">yuer</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨</span>
<span class="nx">promise</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">I love </span><span class="dl">'</span><span class="o">+</span> <span class="nx">str</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="promiseall-å’Œ-promiserace">Promise.all([â€¦]) å’Œ Promise.race([â€¦])</h3>

<p>æœ‰ä¸¤ä¸ªè¾…åŠ©å‡½æ•° Promise.all([â€¦]) å’Œ Promise.race([â€¦])ã€‚å¯¹ Promise.all([â€¦]) æ¥è¯´ï¼Œåªè¦ä¼ å…¥çš„æ‰€æœ‰ promises éƒ½å®Œæˆï¼Œè¿”å› promise æ‰èƒ½å®Œæˆã€‚å¦‚æœæœ‰ä»»ä½• promise è¢«æ‹’ç»ï¼Œè¿”å›çš„ promise å°±ä¼šè¢«æ‹’ç»ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">xiaoke</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// å®Œæˆ</span>
<span class="kd">var</span> <span class="nx">p2</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">yuer</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// å®Œæˆ</span>
<span class="kd">var</span> <span class="nx">p3</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="dl">'</span><span class="s1">Oops</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// æ‹’ç»</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span><span class="nx">p2</span><span class="p">,</span><span class="nx">p3</span><span class="p">]).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">});</span> <span class="c1">// p3 æ‹’ç»ï¼Œæ‰€ä»¥ Promise.all() è¿”å›çš„ promise è¢«æ‹’ç»</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span><span class="nx">p2</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">msgs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msgs</span><span class="p">);</span>
<span class="p">});</span> <span class="c1">// p1, p2 éƒ½å®Œæˆï¼Œè¿”å›çš„ promise ä¸ºå®Œæˆ</span>
<span class="cm">/*
Oops
[ 'xiaoke', 'yuer' ]
*/</span>
</code></pre></div></div>

<p>Promise.race([â€¦]) ä¹Ÿå¥½ç†è§£ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªå†³è®®çš„ promise å–èƒœ(æœ‰å¯èƒ½æ˜¯ å®Œæˆï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ æ‹’ç»)ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Promise</span><span class="p">.</span><span class="nx">race</span><span class="p">([</span><span class="nx">p2</span><span class="p">,</span><span class="nx">p1</span><span class="p">,</span><span class="nx">p3</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
<span class="p">});</span>
<span class="cm">/*
yuer
*/</span>
</code></pre></div></div>

<blockquote>
  <p>å‘ Promise.all([â€¦]) ä¼ å…¥ç©ºæ•°ç»„ä¼šç«‹å³å®Œæˆï¼Œä½† Promise.race([â€¦]) ä¼šæ°¸è¿œæŒ‚èµ·ï¼Œæ°¸è¿œä¸ä¼šå†³è®®ã€‚</p>
</blockquote>

<h3 id="promise-ä¸å¯æ’¤é”€">Promise ä¸å¯æ’¤é”€</h3>

<p>ä¸€æ—¦åˆ›å»ºäº† Promise å¹¶ä¸”æ³¨å†Œäº†ä¸€ä¸ª å®Œæˆ/æ‹’ç» çš„å›è°ƒå‡½æ•°ï¼Œå°±æ²¡æœ‰ä»€ä¹ˆå¯ä»¥ä»å¤–éƒ¨å–åœæ­¢è¿™ä¸ªè¿‡ç¨‹ã€‚</p>

<hr />

<h2 id="async-å’Œ-await">async å’Œ await</h2>

<p><code class="language-plaintext highlighter-rouge">async</code> å’Œ <code class="language-plaintext highlighter-rouge">await</code> å°† Generator å’Œ Promise ç»“åˆèµ·æ¥ï¼Œä»¥ä¸€ç§æ›´ä¸ºâ€œä¼˜é›…â€çš„æ–¹å¼è¿›è¡Œå¼‚æ­¥è°ƒç”¨ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">async</code> ç”¨åœ¨ <code class="language-plaintext highlighter-rouge">function</code> å…³é”®å­—å‰é¢(å¹¶ä¸ä¸€å®šéåœ¨ function å‰é¢ï¼Œå¯¹è±¡çš„æ–¹æ³•å‰é¢ä¹Ÿæ˜¯å¯ä»¥çš„)ã€‚è¡¨è¾¾ä¸€ä¸ªæ„æ€ï¼š<strong>å‡½æ•°æ€»æ˜¯è¿”å›çš„ä¸€ä¸ªpromise</strong>ã€‚å¦‚æœå‡½æ•°è¿”å›ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">&lt;non-promise&gt;</code> çš„ä»£ç ï¼Œä¼šè¢«è‡ªåŠ¨åŒ…è£…æˆä¸€ä¸ª resolved promiseã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="nx">foo</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span> <span class="c1">// 1</span>

<span class="c1">//æ˜¾å¼</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">await</code> åªèƒ½ç”¨åœ¨ <code class="language-plaintext highlighter-rouge">async function</code> å†…éƒ¨ï¼Œä½¿ä»£ç åœæ­¢è¿è¡Œç›´åˆ° Promise å®Œæˆ(è§£ææˆåŠŸæˆ–è¢«æ‹’ç»)å¹¶è¿”å›ä¸€ä¸ªç»“æœã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="dl">"</span><span class="s2">done!</span><span class="dl">"</span><span class="p">),</span> <span class="mi">1000</span><span class="p">))</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">promise</span> <span class="c1">// *</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">foo</span><span class="p">()</span> <span class="c1">// "done!"</span>
</code></pre></div></div>

<p>ä»£ç è¿è¡Œåˆ° * å¤„æš‚åœï¼Œç„¶åç­‰å¾… Promise å®Œæˆã€‚åœ¨ç­‰å¾…æœŸé—´ï¼Œ<code class="language-plaintext highlighter-rouge">await</code> ä¸å ç”¨ CPU èµ„æºï¼ŒCPU å¯ä»¥å¤„ç†å…¶ä»–äº‹æƒ…ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">async</code> å’Œ <code class="language-plaintext highlighter-rouge">await</code> çš„ä¼˜é›…ä¹‹å¤„æ˜¯ï¼Œä»¥åŒæ­¥çš„æ–¹å¼ä¹¦å†™å¼‚æ­¥ä»£ç ã€‚åœ¨ä¹‹å‰çš„ä»‹ç»ä¸­ï¼ŒPromise å¯ä»¥è§£å†³å›è°ƒå‡½æ•° â€œå›è°ƒåœ°ç‹±â€ é—®é¢˜ï¼Œä½†æ˜¯åŒæ ·å¸¦æ¥äº† â€œé“¾å¼åœ°ç‹±â€ çš„é—®é¢˜ã€‚</p>

<p>å…ˆå†™ä¸€ä¸ª Promise çš„ä¾‹å­ï¼Œä½¿ç”¨ Github çš„ APIã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com/users/maoxiaoke</span><span class="dl">'</span><span class="p">)</span> <span class="c1">//è·å–ç”¨æˆ· maoxiaoke çš„ github ä¿¡æ¯</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">githubUser</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">img</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">githubUser</span><span class="p">.</span><span class="nx">avatar_url</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">maoxiaoke</span><span class="dl">'</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">img</span><span class="p">),</span> <span class="mi">3000</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>ç°åœ¨ç”¨ <code class="language-plaintext highlighter-rouge">async</code> å’Œ <code class="language-plaintext highlighter-rouge">await</code> æ”¹å†™ã€‚é¦–å…ˆç”¨ <code class="language-plaintext highlighter-rouge">async</code> å£°æ˜ä¸€ä¸ªå‡½æ•°ï¼Œç„¶ååœ¨å‡½æ•°ä¸­ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">await</code>ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">showAvatar</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com/users/maoxiaoke</span><span class="dl">'</span><span class="p">)</span> 
    <span class="kd">let</span> <span class="nx">githubUser</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>

    <span class="kd">let</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">img</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">githubUser</span><span class="p">.</span><span class="nx">avatar_url</span><span class="p">;</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">promise-avatar-example</span><span class="dl">"</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span>

    <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">3000</span><span class="p">));</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">showAvatar</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>å¤„ç†å¼‚å¸¸æƒ…å†µ</strong>ï¼šPromise ä½¿ç”¨ reject() æ¥å¤„ç†æ‹’ç»çš„æƒ…å†µï¼Œ<code class="language-plaintext highlighter-rouge">async</code> å’Œ <code class="language-plaintext highlighter-rouge">await</code> é‡‡ç”¨ <code class="language-plaintext highlighter-rouge">try...catch...</code> æ¥å¤„ç†ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">showAvatar</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">...</span><span class="dl">'</span><span class="p">)</span> <span class="c1">//è·å–ç”¨æˆ· maoxiaoke çš„ github ä¿¡æ¯</span>
        <span class="kd">let</span> <span class="nx">githubUser</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>

        <span class="kd">let</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">img</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">githubUser</span><span class="p">.</span><span class="nx">avatar_url</span><span class="p">;</span>
        <span class="nx">img</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">promise-avatar-example</span><span class="dl">"</span><span class="p">;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span>

        <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">3000</span><span class="p">));</span>

        <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">showAvatar</span><span class="p">()</span>
</code></pre></div></div>

<p>ä¹Ÿå¯ä»¥è¿™æ ·ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">showAvatar</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">...</span><span class="dl">'</span><span class="p">)</span> <span class="c1">//è·å–ç”¨æˆ· maoxiaoke çš„ github ä¿¡æ¯</span>
    <span class="kd">let</span> <span class="nx">githubUser</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>

    <span class="kd">let</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">img</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">githubUser</span><span class="p">.</span><span class="nx">avatar_url</span><span class="p">;</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">promise-avatar-example</span><span class="dl">"</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span>

    <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">3000</span><span class="p">));</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">showAvatar</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">alert</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">await</code> è¿˜æ”¯æŒ <code class="language-plaintext highlighter-rouge">thenable</code>ã€‚æ‰€æœ‰çš„ Promise éƒ½æ˜¯ thenableï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„ thenable æ˜¯ Promiseã€‚è¿™æ ·çš„ä¸€äº› thenable å¯¹è±¡(ä¸€èˆ¬åŒ…å«å¯è°ƒç”¨çš„ then æ–¹æ³•)å¦‚æœæ”¯æŒå¯è°ƒç”¨çš„ then æ–¹æ³•ï¼Œå°±èƒ½ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">await</code>ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Thenable</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">num</span> <span class="o">=</span> <span class="nx">num</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="nx">resolve</span><span class="p">);</span> 
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1000</span><span class="p">);</span> <span class="c1">// (*)</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">f</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="k">new</span> <span class="nx">Thenable</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="nx">alert</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">f</span><span class="p">();</span>
</code></pre></div></div>
:ET